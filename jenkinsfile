node {
  stage('Init') {
    checkout scm
  }
stage('Deploy1')  
  withCredentials([azureServicePrincipal('principal-credentials-id')]) {
        stage('Deploy1') {
            sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'
            sh 'az account set -s $AZURE_SUBSCRIPTION_ID'
            acrSettings = new JsonSlurper().parseText(
                                            sh(script: "az vm create  --resource-group jenkinsvm-test --name myVM1 --image UbuntuLTS --admin-username azureuser --generate-ssh-keys", returnStdout: true))
        }


  stage('Deploy') {
    withCredentials([azureServicePrincipal(credentialsId: env.AZURE_CRED_ID,
                                    subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                                    clientIdVariable: 'AZURE_CLIENT_ID',
                                    clientSecretVariable: 'AZURE_SECRET',
                                    tenantIdVariable: 'AZURE_TENANT')]) {
                                      
      ansiblePlaybook installation: 'ansible',
      playbook: 'ansible-vm-deploy.yml'
    }

  }
}
